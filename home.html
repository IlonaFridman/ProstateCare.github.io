<!-- file: home.html -->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Care Questions — Home</title>

    <style>
      :root {
        --bg: #f6f9fc;
        --card: #ffffff;
        --ink: #0f172a;
        --muted: #475569;
        --ring: rgba(59, 130, 246, 0.45);
        --shadow: 0 10px 25px rgba(2, 8, 23, 0.12), 0 2px 6px rgba(2, 8, 23, 0.08);
        --radius: 20px;
        --brand: #2563eb;
        --brand-strong:#1d4ed8;
      }

      *{ box-sizing:border-box }
      html,body{ height:100% }
      body{
        margin:0;
        font-family: Arial, ui-sans-serif, system-ui, -apple-system, "Helvetica Neue";
        font-size:17px; color:var(--ink); background:var(--bg);
      }
      body.modal-open{ overflow:hidden }

      .container{ max-width:1200px; margin:20px auto; padding:0 16px }
      .header{ display:flex; gap:16px; justify-content:flex-end; align-items:center; margin-bottom:8px }
      .top-button{
        background:linear-gradient(180deg,#6ea2cf,#588fbe); color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.2);
        border:3px solid #fff; outline:1px solid #c7d9ea; text-decoration:none; padding:14px 22px; border-radius:14px; font-weight:700;
        box-shadow:var(--shadow); transition:transform .06s ease, filter .15s ease;
      }
      .top-button:hover{ filter:brightness(1.05); transform:translateY(-1px) }
      .top-button:focus-visible{ outline:3px solid var(--ring); outline-offset:3px }

      /* Cards */
      .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:22px }
      .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:12px; min-height:220px; border:1px solid #e5e7eb }
      .thumb{ width:100%; height:160px; border-radius:14px; background:#e9eef5; margin-bottom:12px; overflow:hidden; display:block }
      .thumb img{ width:100%; height:100%; object-fit:cover; display:block }
      .card-title a{ display:inline-block; text-decoration:none; color:inherit; font-weight:800 }
      .card-title{ font-size:20px; font-weight:800; line-height:1.2 }
      .card-desc{ font-size:15px; color:var(--muted); margin-top:6px; line-height:1.35 }
      @media (max-width:900px){ .grid{ grid-template-columns:1fr 1fr } }
      @media (max-width:640px){ .grid{ grid-template-columns:1fr } .header{ justify-content:center } }

      /* Modal base */
      .modal{ position:fixed; inset:0; display:none; z-index:999 }
      .modal[aria-hidden="false"]{ display:block }
      .modal-backdrop{ position:absolute; inset:0; background:rgba(15,23,42,.55); backdrop-filter:blur(4px) }
      .icon-btn.close{ position:absolute; right:10px; top:10px; background:#efefef; border:none; border-radius:999px; width:36px; height:36px; cursor:pointer }

      /* Instructions window (blocking) */
      .intro-window .modal-card{
        position:relative; max-width:980px; margin:7vh auto; background:var(--card);
        border-radius:22px; box-shadow:var(--shadow); padding:20px; border:1px solid #e5e7eb;
        max-height:84vh; overflow:auto;
      }

      /* Side-by-side layout */
      .intro-layout{
        display:grid; gap:16px;
        grid-template-columns: 1fr; align-items:start;
      }
      @media (min-width:768px){
        .intro-layout{
          grid-template-columns: 1.3fr 1fr;
        }
      }
      .intro-copy h1{ margin:2px 0 10px; font-size:28px; line-height:1.2 }
      .intro-copy .lede{ color:var(--muted); margin:0 0 12px }
      .intro-copy ul{ margin:10px 0 8px 22px }
      .intro-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }

      .btn{
        display:inline-flex; align-items:center; gap:10px; text-decoration:none; font-weight:800; line-height:1;
        border-radius:12px; padding:12px 16px; border:1px solid transparent; cursor:pointer;
      }
      .btn-primary{ background:linear-gradient(180deg,var(--brand),var(--brand-strong)); color:#fff; box-shadow:var(--shadow) }
      .btn-secondary{ background:#f1f59; color:#0b2a5d; border-color:#c7d9ea }

      .intro-media{
        width:100%; height:100%;
        min-height:220px;
        background:#f7fafc; border:1px solid #e5e7eb; border-radius:16px;
        overflow:hidden; box-shadow:0 2px 10px rgba(2,8,23,.06)
      }
      .intro-media img{
        width:100%; height:100%; object-fit:cover; display:block;
      }

      /* Existing Start modal */
      .start-modal .modal-card{ position:relative; max-width:960px; margin:6vh auto; background:var(--card); border-radius:22px; box-shadow:var(--shadow); padding:24px 22px 16px; border:1px solid #e5e7eb; max-height:85vh; overflow-y:auto }
      .modal-header h2{ margin:4px 0 8px; font-size:28px }
      .lede{ color:var(--muted); margin:0 0 14px; font-size:16px }
      .accordion{ display:flex; flex-direction:column; gap:12px }
      .section{ border:1px solid #d9e3f5; border-radius:16px; background:#f7fbff; overflow:hidden }
      .section summary{ list-style:none; cursor:pointer; padding:12px 16px 12px 36px; font-weight:800; color:#0c2f66; background:#edf4ff; border-bottom:1px solid #d9e3f5; outline:none; position:relative }
      .section summary::before{ content:""; position:absolute; left:14px; top:50%; transform:translateY(-50%); width:0; height:0; border-style:solid; border-width:6px 0 6px 8px; border-color:transparent transparent transparent #0b2a5d; transition: transform .18s ease }
      .section[open] summary::before{ transform:translateY(-50%) rotate(90deg) }
      .section[open] summary{ background:#dce9ff }
      .section-content{ max-height:35vh; overflow-y:auto; padding:8px }
      .section-toolbar{ display:flex; gap:8px; padding:6px 6px 8px 6px; align-items:center; flex-wrap:wrap }
      .mini{ border:1px solid #cbd5e1; background:#fff; color:#374151; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer; transition:background-color .15s ease }
      .mini:hover{ background-color:#f9fafb }
      .eres-btn{ margin-left:auto; border:1px solid #94a3b8; background:#fff; border-radius:12px; padding:8px 14px; font-weight:800; text-decoration:none; color:#0b2a5d; display:inline-flex; align-items:center; line-height:1 }
      .eres-btn:hover{ background:#f1f5f9 }
      .q-list{ list-style:none; padding:0; margin:0 }
      .q-list li{ display:flex; gap:10px; padding:10px 8px; border-bottom:1px solid #eaeef5; line-height:1.35 }
      .q-list li:last-child{ border-bottom:none }
      .modal-footer{ display:flex; gap:12px; justify-content:space-between; align-items:center; margin-top:12px; flex-wrap:wrap; padding-bottom:8px }
      .secondary{ background:linear-gradient(180deg,#6ea2cf,#588fbe); color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.2); border:2px solid #fff; outline:1px solid #c7d9ea; border-radius:12px; text-decoration:none; font-weight:700; transition:transform .06s ease, filter .15s ease }
      .links-pack{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start }
      .links-pack>h2{ flex:0 0 100%; margin:0 0 8px 0 }
      .links-pack .secondary{ display:inline-flex; align-items:center; padding:8px 12px; line-height:1.2; white-space:normal; flex:0 1 auto; border-radius:12px }

      /* Print/handout + FAB */
      .print-stage{ position:fixed; left:-10000px; top:-10000px; width:794px; padding:24px; background:#fff }
      .handout{ font-family:Arial, Helvetica, sans-serif; color:#0f172a; line-height:1.55; font-size:18px }
      .handout .frame{ border:6px solid #6aa1cc; border-radius:36px; padding:16px }
      .handout .chip{ display:block; text-align:center; font-weight:700; font-size:22px; color:#1b4e73; background:#e8f3ff; border:4px solid #6aa1cc; border-radius:16px; padding:10px 14px; margin:8px auto 14px; width:fit-content; min-width:340px }
      .handout .panel{ border:6px solid #6aa1cc; border-radius:28px; padding:16px; min-height:160px }
      .handout h4{ margin:0 0 8px; font-size:18px }
      .handout ul{ margin:0; padding-left:22px }
      .handout li{ margin:8px 0 }
      .fab{ position:fixed; right:18px; bottom:18px; z-index:998; display:inline-flex; align-items:center; gap:8px; padding:12px 16px; font-weight:800; border-radius:999px; border:1px solid #c7d9ea; background:#e8efff; color:#0b2a5d; box-shadow:var(--shadow); cursor:pointer }
      .fab:focus-visible{ outline:3px solid var(--ring); outline-offset:2px }
      @media (max-width:480px){ .fab{ right:12px; bottom:12px; padding:10px 14px } }
    </style>
  </head>

  <body>
    <header class="container header">
      <a class="top-button" href="https://ilonafridman.github.io/ProstateCare.github.io/careteam.html">Your Care Team</a>
      <a class="top-button" href="https://ilonafridman.github.io/ProstateCare.github.io/information.html">Helpful Information Online</a>
    </header>

    <!-- BLOCKING Instructions Window -->
    <div class="modal intro-window" id="introModal" role="dialog" aria-modal="true" aria-labelledby="introTitle" aria-hidden="true">
      <div class="modal-backdrop" aria-hidden="true"></div>
      <div class="modal-card" role="document">
        <button class="icon-btn close" aria-label="Close instructions window" data-intro-close>✕</button>

        <div class="intro-layout">
          <div class="intro-copy">
            <h1 id="introTitle">The guide for your cancer journey</h1>
            <p>
              Finding out you have cancer can feel confusing and scary. It might seem like you're getting lots of puzzle pieces of
              information and it's hard to see the whole picture.
            </p>
            <p><strong>You don’t have to figure it all out at once!</strong></p>
            <p>We’ve broken things down into several steps that outline your journey. For each step, you'll find:</p>
            <ul>
              <li>Questions to help you talk to your doctors and nurses.</li>
              <li>Good websites with safe and helpful information.</li>
            </ul>
            <p><strong>You're in control.</strong> Explore the section that feels right for you, or select "Start Here" to see a shorter list of questions.</p>

            <div class="intro-actions" role="group" aria-label="Instructions actions">
              <button class="btn btn-primary" type="button" data-intro-close>Explore here</button>
              <a class="btn btn-secondary" href="#" data-open="startModal" aria-haspopup="dialog" aria-controls="startModal">Open “Start here”</a>
            </div>
          </div>

          <figure class="intro-media" aria-label="Prostate cancer information booklets">
            <img
              src="https://ilonafridman.github.io/ProstateCare.github.io/ProstateBooklets.png"
              alt="A set of prostate cancer information booklets laid out together."
              loading="eager"
              decoding="async"
            />
          </figure>
        </div>
      </div>
    </div>

    <!-- Cards -->
    <main class="container grid" aria-label="Topics">
      <div class="card">
        <a class="thumb" href="#" data-open="startModal" aria-haspopup="dialog" aria-controls="startModal">
          <img src="https://ilonafridman.github.io/ProstateCare.github.io/Starthere.jpg" alt="People jogging with the word Start on the track" />
        </a>
        <div class="card-title">
          <a href="#" data-open="startModal" aria-haspopup="dialog" aria-controls="startModal">Start Here</a>
        </div>
        <p class="card-desc">A short list of questions to ask your doctor.</p>
      </div>

      <div class="card">
        <a class="thumb" href="https://ilonafridman.github.io/ProstateCare.github.io/diagnosis/diagnosis.html">
          <img src="https://ilonafridman.github.io/ProstateCare.github.io/AfterDiagnosis.jpg" alt="After diagnosis image" />
        </a>
        <div class="card-title">
          <a href="https://ilonafridman.github.io/ProstateCare.github.io/diagnosis/diagnosis.html">Questions to ask after being diagnosed</a>
        </div>
      </div>

      <div class="card">
        <a class="thumb" href="https://ilonafridman.github.io/ProstateCare.github.io/choosingtreatment/choosingtreatment.html">
          <img src="https://ilonafridman.github.io/ProstateCare.github.io/ChoosingTreatment.png" alt="Choosing treatment image" />
        </a>
        <div class="card-title">
          <a href="https://ilonafridman.github.io/ProstateCare.github.io/choosingtreatment/choosingtreatment.html">Questions to explore when choosing treatment</a>
        </div>
      </div>

      <div class="card">
        <a class="thumb" href="https://ilonafridman.github.io/ProstateCare.github.io/treatment/treatment.html">
          <img src="https://ilonafridman.github.io/ProstateCare.github.io/DuringTreatment.png" alt="During treatment image" />
        </a>
        <div class="card-title">
          <a href="https://ilonafridman.github.io/ProstateCare.github.io/treatment/treatment.html">Questions to ask during treatment</a>
        </div>
      </div>

      <div class="card">
        <a class="thumb" href="https://ilonafridman.github.io/ProstateCare.github.io/aftertreatment/aftertreatment.html">
          <img src="https://ilonafridman.github.io/ProstateCare.github.io/AfterTreatment.png" alt="After treatment image" />
        </a>
        <div class="card-title">
          <a href="https://ilonafridman.github.io/ProstateCare.github.io/aftertreatment/aftertreatment.html">Questions to ask after treatment</a>
        </div>
      </div>

      <div class="card">
        <a class="thumb" href="https://ilonafridman.github.io/ProstateCare.github.io/complementary/complementary.html">
          <img src="https://ilonafridman.github.io/ProstateCare.github.io/Complementary Therapy.jpg" alt="Complementary therapy image" />
        </a>
        <div class="card-title">
          <a href="https://ilonafridman.github.io/ProstateCare.github.io/complementary/complementary.html">Questions to ask about integrative therapy</a>
        </div>
      </div>
    </main>

    <!-- FAB: Back to instructions -->
    <button id="backToInstructions" class="fab" type="button" aria-haspopup="dialog" aria-controls="introModal">
      ⟲ Back to instructions
    </button>

    <!-- Start Here Modal -->
    <div class="modal start-modal" id="startModal" role="dialog" aria-modal="true" aria-labelledby="startModalTitle" aria-hidden="true">
      <div class="modal-backdrop" aria-hidden="true"></div>
      <div class="modal-card" role="document">
        <button class="icon-btn close" aria-label="Close dialog" data-close="startModal">✕</button>

        <div class="modal-header" aria-describedby="startModalIntro">
          <h2 id="startModalTitle">Questions to ask your provider</h2>
          <div id="startModalIntro" class="lede-panel">
            <p>Many patients wonder, 'What should I ask my provider? How can I move forward?'</p>
           <ul>
    <li><strong>Pick your questions:</strong> Open a section and check the box next to any question to bring to your doctors and nurses.</li>
    <li><strong>Get your list:</strong> You can download or print the questions you picked.</li>
    <li><strong>Learn more:</strong> You can also explore the helpful websites by selecting eResources within each section.</li>
  </ul>
            <h3 id="startModalTitle">Choose 3–5 questions for your next appointment</h3>
          </div>
        </div>

        <div class="accordion" id="accordion"></div>

        <div class="modal-footer">
          <div class="action-buttons-group">
            <h3 id="startModalTitle">Download or print your chosen questions</h3>
            <button id="downloadPdfBtn" class="mini" type="button">Download PDF</button>
            <button id="printBtn" class="mini" type="button">Print</button>
          </div>

          <div class="links-pack">
            <h2 id="startModalTitle">More questions to explore</h2>
            <a class="secondary" href="https://ilonafridman.github.io/ProstateCare.github.io/diagnosis/diagnosis.html">After being diagnosed</a>
            <a class="secondary" href="https://ilonafridman.github.io/ProstateCare.github.io/choosingtreatment/choosingtreatment.html">Choosing treatment</a>
            <a class="secondary" href="https://ilonafridman.github.io/ProstateCare.github.io/treatment/treatment.html">During treatment</a>
            <a class="secondary" href="https://ilonafridman.github.io/ProstateCare.github.io/aftertreatment/aftertreatment.html">After treatment</a>
            <a class="secondary" href="https://ilonafridman.github.io/ProstateCare.github.io/complementary/complementary.html">About integrative therapy</a>
          </div>
        </div>
      </div>
    </div>

    <div id="printStage" class="print-stage" aria-hidden="true"></div>

    <!-- Modal handlers -->
    <script>
      (function () {
        // WHY sessionStorage? Show intro once per browser session; show again only after user leaves/ends session.
        const INTRO_KEY = 'cq_intro_seen_session_v1';
        const storage = window.sessionStorage;

        const hasSeenIntro = () => {
          try { return storage.getItem(INTRO_KEY) === '1'; } catch { return false; }
        };
        const markIntroSeen = () => {
          try { storage.setItem(INTRO_KEY, '1'); } catch {}
        };

        let focusTrapHandler = null;

        function trapFocus(root) {
          const FOCUSABLE = 'a[href], area[href], input, select, textarea, button, summary, [tabindex]:not([tabindex="-1"])';
          const nodes = () => Array.from(root.querySelectorAll(FOCUSABLE)).filter(el => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
          function onFocusIn(e) {
            if (!root.contains(e.target)) {
              const list = nodes();
              if (list.length) list[0].focus();
            }
          }
          function onKeydown(e) {
            if (e.key !== 'Tab') return;
            const list = nodes();
            if (!list.length) return;
            const first = list[0], last = list[list.length - 1];
            if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
            else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
          }
          focusTrapHandler = { onFocusIn, onKeydown };
          document.addEventListener('focusin', onFocusIn);
          document.addEventListener('keydown', onKeydown);
        }

        function releaseFocusTrap() {
          if (!focusTrapHandler) return;
          document.removeEventListener('focusin', focusTrapHandler.onFocusIn);
          document.removeEventListener('keydown', focusTrapHandler.onKeydown);
          focusTrapHandler = null;
        }

        function openModal(id) {
          const el = document.getElementById(id);
          if (!el) return;
          el.setAttribute('aria-hidden', 'false');
          document.body.classList.add('modal-open');
          const first = el.querySelector('button,[href],input,summary,[tabindex]:not([tabindex="-1"])');
          if (first) first.focus();
          trapFocus(el);
        }

        function closeModal(id) {
          const el = document.getElementById(id);
          if (!el) return;
          el.setAttribute('aria-hidden', 'true');

          if (id === 'introModal') {
            markIntroSeen(); // ensure we never show it again this session
          }

          releaseFocusTrap();
          const anyOpen = document.querySelector('.modal[aria-hidden="false"]');
          if (!anyOpen) document.body.classList.remove('modal-open');
        }

        function escClose(e) {
          if (e.key === 'Escape') {
            const openModals = Array.from(document.querySelectorAll('.modal[aria-hidden="false"]'));
            if (openModals.some(m => m.id === 'introModal')) {
              markIntroSeen();
            }
            openModals.forEach(m => m.setAttribute('aria-hidden', 'true'));
            releaseFocusTrap();
            document.body.classList.remove('modal-open');
          }
        }

        // Open Start Here
        document.addEventListener('click', (e) => {
          const openBtn = e.target.closest('[data-open="startModal"]');
          if (openBtn) {
            e.preventDefault();
            markIntroSeen();
            closeModal('introModal');
            openModal('startModal');
          }
        });

        // Close Intro via dedicated buttons
        document.addEventListener('click', (e) => {
          const closeIntro = e.target.closest('[data-intro-close]');
          if (closeIntro) {
            e.preventDefault();
            markIntroSeen();
            closeModal('introModal');
          }
        });

        // Generic close for other modals
        document.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-close]');
          if (btn) {
            e.preventDefault();
            closeModal(btn.getAttribute('data-close'));
          }
        });

        const back = document.getElementById('backToInstructions');
        if (back) back.addEventListener('click', () => { closeModal('startModal'); openModal('introModal'); });

        document.addEventListener('keydown', escClose);

        // Mark as seen when navigating within same origin (prevents re-open when returning from other pages)
        function isSameOrigin(href) {
          try { return new URL(href, location.href).origin === location.origin; } catch { return false; }
        }
        document.addEventListener('click', (e) => {
          const a = e.target.closest('a[href]');
          if (!a) return;
          if (isSameOrigin(a.getAttribute('href') || a.href)) {
            markIntroSeen();
          }
        });

        // On first view this session: open intro once, then mark seen immediately.
        function handleInitialShow() {
          const intro = document.getElementById('introModal');
          if (!hasSeenIntro()) {
            openModal('introModal');
            markIntroSeen(); // if user navigates away without closing, it won't pop again this session
          } else {
            if (intro) intro.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
          }
        }

        // Run on normal load AND on BFCache restore (back/forward)
        window.addEventListener('DOMContentLoaded', handleInitialShow);
        window.addEventListener('pageshow', handleInitialShow);
      })();
    </script>

    <!-- Start Here: data + rendering + handout actions -->
    <script>
      // ---------- Data ----------
      const TOPICS = {
        diagnosis: {
          title: "I would like to understand my diagnosis better",
          questions: [
            "What does PSA score and stage of prostate cancer mean?",
            "How fast is my cancer growing?",
            "Do I need any more tests or biopsies to be sure about my diagnosis?",
            "How much time do I have to decide on my treatment?",
            "Which doctors should I see, and when should I see them?"
          ]
        },
        choosing: {
          title: "I need to choose a treatment",
          questions: [
            "What treatment options do I have?",
            "Which treatment gives the lowest chance of the cancer coming back?",
            "If you were in my place, which treatment would you choose?",
            "What happens if I decide not to have surgery, radiation, or hormonetherapy?",
            "How soon do I need to start treatment?",
            "Do I have time to get a second opinion?",
            "What are my surgery options?",
            "What are the side effects of radiation?",
            "Will I need hormone therapy?"
          ]
        },
        during: {
          title: "I am going through treatment",
          questions: [
            "Can you walk me through the steps involved in my treatment plan?",
            "What side effects should I expect from my treatment?",
            "Are there any tools or tips you recommend for coping with common side effects?",
            "When should I contact my healthcare team between visits?",
            "What should I do if my personal situation makes it hard to get to treatment?",
            "Are there counselors or support groups available?",
            "What integrative therapy services are available to support me during treatment?",
            "The cost of my treatment is high — what options do I have for financial assistance?"
          ]
        },
        after: {
          title: "I completed my treatment. What is next?",
          questions: [
            "Which specific tests will I need during follow-up, and how often?",
            "Who will coordinate my follow-up care?",
            "What symptoms should prompt me to contact you between scheduled visits?",
            "Am I at increased risk for any health conditions because of my treatment?",
            "Are there lifestyle changes or behaviors you recommend to help reduce the risk of cancer coming back?",
            "Can you recommend support groups or counseling services for survivors with prostate cancer?"
          ]
        },
        integrative: {
          title: "I hope to learn about complementary and integrative therapy",
          questions: [
            "Can any vitamins, herbs, or lifestyle changes make my treatment less effective or cause side effects?",
            "How do I know if a supplement or therapy is safe for me?",
            "Where can I find good information about complementary therapies for people with cancer?",
            "What should I eat or drink during treatment to help me stay strong and recover better?",
            "Where can I find a doctor or specialist who works in integrative medicine?"
          ]
        }
      };

      const ER_LINKS = {
        diagnosis: "https://ilonafridman.github.io/ProstateCare.github.io/diagnosis/diagnosisinfo.html",
        choosing: "https://ilonafridman.github.io/ProstateCare.github.io/choosingtreatment/choosingtreatmentinfo.html",
        during: "https://ilonafridman.github.io/ProstateCare.github.io/treatment/treatmentinfo.html",
        after: "https://ilonafridman.github.io/ProstateCare.github.io/aftertreatment/aftertreatmentinfo.html",
        integrative: "https://ilonafridman.github.io/ProstateCare.github.io/complementary/complementaryinfo.html"
      };

      const RECOMMENDATIONS = [
        "<b>Consider bringing a friend or loved one</b> to help you remember information shared during your appointment.",
        "<b>Learn about your specific condition</b> from trusted sources of information.",
        "<b>Your healthcare team welcomes your questions.</b> Don’t hesitate to ask to clarify anything you're unsure about.",
        "<b>Your questions are important.</b> Sharing your questions at the beginning of the appointment will help address your concerns.",
        "<b>Stay connected between visits.</b> Use the patient portal, phone, or email to reach the team when questions arise.",
        "<b>Connect with others.</b> Support groups, social workers, and patient advocates can provide emotional support and resources."
      ];

      // ---------- Build sections ----------
      const container = document.getElementById("accordion");

      function buildSections() {
        if (!container) return;
        container.innerHTML = "";
        Object.entries(TOPICS).forEach(([key, topic]) => {
          const details = document.createElement("details");
          details.className = "section";
          details.open = false;

          const summary = document.createElement("summary");
          summary.textContent = topic.title;

          const wrap = document.createElement("div");
          wrap.className = "section-content";

          const toolbar = document.createElement("div");
          toolbar.className = "section-toolbar";

          const selectBtn = document.createElement("button");
          selectBtn.className = "mini";
          selectBtn.type = "button";
          selectBtn.textContent = "Select all";

          const clearBtn = document.createElement("button");
          clearBtn.className = "mini";
          clearBtn.type = "button";
          clearBtn.textContent = "Clear all";

          const er = document.createElement("a");
          er.className = "eres-btn";
          er.href = ER_LINKS[key] || "#";
          er.target = "_blank";
          er.rel = "noopener";
          er.setAttribute("aria-label", `Open eResources to Read for ${topic.title}`);
          er.textContent = "eResources to Read";

          const list = document.createElement("ul");
          list.className = "q-list";
          topic.questions.forEach((q, i) => {
            const id = `q-${key}-${i}`;
            const li = document.createElement("li");
            li.innerHTML = `<input type="checkbox" id="${id}" /><label for="${id}">${q}</label>`;
            list.appendChild(li);
          });

          selectBtn.addEventListener("click", () => {
            list.querySelectorAll('input[type="checkbox"]').forEach((cb) => (cb.checked = true));
          });
          clearBtn.addEventListener("click", () => {
            list.querySelectorAll('input[type="checkbox"]').forEach((cb) => (cb.checked = false));
          });

          toolbar.appendChild(selectBtn);
          toolbar.appendChild(clearBtn);
          toolbar.appendChild(er);
          wrap.appendChild(toolbar);
          wrap.appendChild(list);
          details.appendChild(summary);
          details.appendChild(wrap);
          container.appendChild(details);
        });
      }

      // ---------- Selection helpers ----------
      function getSelectedByTopic() {
        const grouped = {};
        document.querySelectorAll(".q-list input[type='checkbox']:checked").forEach((cb) => {
          const key = cb.id.split("-")[1];
          const text = cb.nextElementSibling.textContent.trim();
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push(text);
        });
        return grouped;
      }

      // ---------- Handout ----------
      function handoutHTML(grouped) {
        const instructions = `
          <div class="panel">
            <p>Here are the questions you choose to ask your doctors.</p>
            <ul>
              <li>Your doctors and nurses are happy to answer your questions. Don’t hesitate to ask!</li>
              <li>It's okay to ask different doctors for help. Each one is an expert on a different part of your care—reach more than one expert!</li>
              <li>Think about your most important questions for today. If you have more than 3–5 questions, you might need more than one visit to clarify all of them.</li>
            </ul>
          </div>`;

        const keys = Object.keys(grouped);
        let questionsHTML = "";
        if (keys.length === 0) {
          questionsHTML = `<div class="panel"><p>(Chosen questions appear here.)</p></div>`;
        } else {
          questionsHTML = keys
            .map((key) => {
              const title = TOPICS[key]?.title || key;
              const items = grouped[key].map((q) => `<li>${q}</li>`).join("");
              return `<div class="panel"><h4>${title}</h4><ul>${items}</ul></div>`;
            })
            .join('<div style="height:14px"></div>');
        }

        const recs = RECOMMENDATIONS.map((r) => `<li>${r}</li>`).join("");

        return `
          <div class="handout">
            <div class="frame">
              <span class="chip">Questions that you chose</span>
              ${instructions}
              <div style="height:14px"></div>
              ${questionsHTML}
              <div style="height:18px"></div>
              <span class="chip">Recommendations that other patients found helpful</span>
              <div class="panel"><ul>${recs}</ul></div>
            </div>
          </div>`;
      }

      function buildHandoutStage() {
        const grouped = getSelectedByTopic();
        const stage = document.getElementById("printStage");
        stage.innerHTML = handoutHTML(grouped);
        return stage.firstElementChild;
      }

      // ---------- PDF ----------
      async function createHandoutPDF() {
        const root = buildHandoutStage(); // .handout
        const frame = root.querySelector(".frame");

        const pdf = new window.jspdf.jsPDF({ unit: "mm", format: "a4", compress: true });
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const margin = 10;
        const contentW = pageW - margin * 2;
        const contentH = pageH - margin * 2;
        const overlapPx = 6;

        let cursorHmm = 0;

        const blocks = Array.from(frame.children).filter(
          (el) => el.classList.contains("chip") || el.classList.contains("panel")
        );

        for (const el of blocks) {
          const canvas = await html2canvas(el, {
            backgroundColor: "#ffffff",
            scale: Math.min(2, window.devicePixelRatio || 1.5)
          });

          const pxPerMm = canvas.width / contentW;
          const blockHmm = canvas.height / pxPerMm;

          if (cursorHmm > 0 && cursorHmm + blockHmm > contentH) {
            pdf.addPage();
            cursorHmm = 0;
          }

          if (blockHmm <= contentH) {
            pdf.addImage(canvas.toDataURL("image/png"), "PNG", margin, margin + cursorHmm, contentW, blockHmm);
            cursorHmm += blockHmm + 2;
          } else {
            let y = 0;
            const pageContentHPx = contentH * pxPerMm;
            while (y < canvas.height) {
              const sliceH = Math.min(pageContentHPx, canvas.height - y);
              const c = document.createElement("canvas");
              c.width = canvas.width;
              c.height = sliceH;
              c.getContext("2d").drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, canvas.width, sliceH);
              const sliceHmm = sliceH / pxPerMm;

              if (cursorHmm > 0) {
                pdf.addPage();
                cursorHmm = 0;
              }
              pdf.addImage(c.toDataURL("image/png"), "PNG", margin, margin + cursorHmm, contentW, sliceHmm);
              y += sliceH - overlapPx;
              if (y < canvas.height) {
                pdf.addPage();
                cursorHmm = 0;
              }
            }
            cursorHmm = 2;
          }
        }
        return pdf;
      }

      // ---------- Actions ----------
      async function downloadSelectedAsPDF() {
        const pdf = await createHandoutPDF();
        pdf.save("questions-handout.pdf");
      }

      function printSelected() {
        const html = `<!doctype html><html><head><meta charset="utf-8"><title>Questions Handout</title><style>${
          document.querySelector("style").innerHTML
        }</style></head><body onload="window.print()"><div style="padding:24px;max-width:850px;margin:0 auto">${
          handoutHTML(getSelectedByTopic())
        }</div></body></html>`;
        const w = window.open("", "_blank");
        w.document.open();
        w.document.write(html);
        w.document.close();
      }

      // Wire up after DOM is ready so buttons exist
      window.addEventListener("DOMContentLoaded", () => {
        buildSections();
        document.getElementById("downloadPdfBtn").addEventListener("click", downloadSelectedAsPDF);
        document.getElementById("printBtn").addEventListener("click", printSelected);
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
  </body>
</html>
